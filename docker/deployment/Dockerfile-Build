ARG IMAGE_NAME

# Composer
FROM composer:2.1.8 as composer

# Build PHP FPM & NGINX
FROM $IMAGE_NAME

RUN apk update && apk add --no-cache libpng libpng-dev libwebp-dev libjpeg-turbo-dev freetype-dev jpeg-dev

RUN docker-php-ext-configure gd \
        --with-freetype=/usr/lib/ \
        --with-jpeg=/usr/lib/ \
        --with-webp=/usr/lib/

RUN NUMPROC=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || 1) \
    && docker-php-ext-install -j${NUMPROC} gd \
    && docker-php-ext-enable gd

RUN docker-php-ext-configure intl \
    && docker-php-ext-install intl

RUN wget -O elastic-apm.apk https://github.com/elastic/apm-agent-php/releases/download/v1.7.1/apm-agent-php_1.7.1_all.apk
RUN apk --allow-untrusted add elastic-apm.apk 

# RUN mkdir -p /home/apm-agent && \
#     cd /home/apm-agent && \
#     git clone https://github.com/elastic/apm-agent-php.git apm && \
#     cd apm/src/ext && \
#     /usr/local/bin/phpize && ./configure --enable-elastic_apm && \
#     make clean && make && make install

RUN rm -Rf /var/www/hmtl/elastic-apm.apk \
           /etc/nginx/conf.d/default.conf && \
           composer --version

COPY ./docker/config/php.ini /usr/local/etc/php/php.ini
COPY ./docker/config/elastic_apm.ini /opt/elastic/apm-agent-php/etc/elastic-apm-custom.ini
COPY ./docker/config/fpm-pool.conf /usr/local/etc/php-fpm.d/03-fpm-pool.conf
COPY ./docker/config/nginx.conf /etc/nginx/nginx.conf
